name: Dependency Security Scan

on:
  push:
    branches:
      - main
    paths:
      - '**/requirements.txt'
  pull_request:
    branches:
      - main
    paths:
      - '**/requirements.txt'
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

jobs:
  dependency-scan:
    name: Scan Python Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Scan all services
        run: |
          SERVICES=("user_service" "appointment_service" "staff_management" "service_management" "reports_analytics" "notification_service")
          
          echo "## Dependency Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for service in "${SERVICES[@]}"; do
            echo "### ${service}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "${service}/requirements.txt" ]; then
              echo "Scanning ${service}..."
              pip-audit -r "${service}/requirements.txt" --format markdown >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Vulnerabilities found in ${service}" >> $GITHUB_STEP_SUMMARY
            else
              echo "No requirements.txt found" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
          done

  trivy-filesystem:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem'
