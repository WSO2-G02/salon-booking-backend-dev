name: DAST Security Scan (OWASP ZAP)

# This workflow scans a LIVE/RUNNING application for security vulnerabilities.
# Prerequisites: Load Balancer + DNS + HTTPS must be configured first.
#
# Usage:
#   1. Go to Actions tab in GitHub
#   2. Select "DAST Security Scan (OWASP ZAP)"
#   3. Click "Run workflow"
#   4. Enter the target URL (e.g., https://api.aurora-glam.com)
#   5. Select scan type and run

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan (e.g., https://api.aurora-glam.com)'
        required: true
        type: string
      scan_type:
        description: 'Scan type: baseline (quick), api (OpenAPI), full (deep)'
        required: true
        type: choice
        options:
          - baseline
          - api
          - full
        default: 'baseline'
  # Uncomment schedule once production is ready
  # schedule:
  #   - cron: '0 2 * * 0'

jobs:
  zap-scan:
    name: OWASP ZAP Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ZAP Baseline Scan
        if: github.event.inputs.scan_type == 'baseline' || github.event_name == 'schedule'
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ github.event.inputs.target_url || 'http://localhost:8000' }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: true
          fail_action: false

      - name: ZAP API Scan
        if: github.event.inputs.scan_type == 'api'
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: ${{ github.event.inputs.target_url }}/openapi.json
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: true
          fail_action: false

      - name: ZAP Full Scan
        if: github.event.inputs.scan_type == 'full'
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: ${{ github.event.inputs.target_url }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: true
          fail_action: false

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-report
          path: report_html.html
          retention-days: 30
